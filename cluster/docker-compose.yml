version: '3.8'

# Redis Cluster with port mapping for Windows Docker Desktop
# Uses port mapping instead of host networking for Windows compatibility
services:
  redis-node-1:
    image: redis:7.0-alpine
    container_name: redis-cluster-1
    restart: always
    ports:
      - "7000:7000"
      - "17000:17000"
    command: >
      redis-server 
      --port 7000 
      --cluster-enabled yes 
      --cluster-config-file nodes.conf 
      --cluster-node-timeout 5000 
      --appendonly yes 
      --protected-mode no 
      --bind 0.0.0.0
    volumes:
      - cluster-data-1:/data
    networks:
      redis-cluster-net:
        ipv4_address: 172.28.0.11

  redis-node-2:
    image: redis:7.0-alpine
    container_name: redis-cluster-2
    restart: always
    ports:
      - "7001:7001"
      - "17001:17001"
    command: >
      redis-server 
      --port 7001 
      --cluster-enabled yes 
      --cluster-config-file nodes.conf 
      --cluster-node-timeout 5000 
      --appendonly yes 
      --protected-mode no 
      --bind 0.0.0.0
    volumes:
      - cluster-data-2:/data
    networks:
      redis-cluster-net:
        ipv4_address: 172.28.0.12

  redis-node-3:
    image: redis:7.0-alpine
    container_name: redis-cluster-3
    restart: always
    ports:
      - "7002:7002"
      - "17002:17002"
    command: >
      redis-server 
      --port 7002 
      --cluster-enabled yes 
      --cluster-config-file nodes.conf 
      --cluster-node-timeout 5000 
      --appendonly yes 
      --protected-mode no 
      --bind 0.0.0.0
    volumes:
      - cluster-data-3:/data
    networks:
      redis-cluster-net:
        ipv4_address: 172.28.0.13

  redis-node-4:
    image: redis:7.0-alpine
    container_name: redis-cluster-4
    restart: always
    ports:
      - "7003:7003"
      - "17003:17003"
    command: >
      redis-server 
      --port 7003 
      --cluster-enabled yes 
      --cluster-config-file nodes.conf 
      --cluster-node-timeout 5000 
      --appendonly yes 
      --protected-mode no 
      --bind 0.0.0.0
    volumes:
      - cluster-data-4:/data
    networks:
      redis-cluster-net:
        ipv4_address: 172.28.0.14

  redis-node-5:
    image: redis:7.0-alpine
    container_name: redis-cluster-5
    restart: always
    ports:
      - "7004:7004"
      - "17004:17004"
    command: >
      redis-server 
      --port 7004 
      --cluster-enabled yes 
      --cluster-config-file nodes.conf 
      --cluster-node-timeout 5000 
      --appendonly yes 
      --protected-mode no 
      --bind 0.0.0.0
    volumes:
      - cluster-data-5:/data
    networks:
      redis-cluster-net:
        ipv4_address: 172.28.0.15

  redis-node-6:
    image: redis:7.0-alpine
    container_name: redis-cluster-6
    restart: always
    ports:
      - "7005:7005"
      - "17005:17005"
    command: >
      redis-server 
      --port 7005 
      --cluster-enabled yes 
      --cluster-config-file nodes.conf 
      --cluster-node-timeout 5000 
      --appendonly yes 
      --protected-mode no 
      --bind 0.0.0.0
    volumes:
      - cluster-data-6:/data
    networks:
      redis-cluster-net:
        ipv4_address: 172.28.0.16

  redis-cluster-creator:
    image: redis:7.0-alpine
    container_name: redis-cluster-creator
    depends_on:
      - redis-node-1
      - redis-node-2
      - redis-node-3
      - redis-node-4
      - redis-node-5
      - redis-node-6
    command: >
      sh -c "
        echo 'Waiting for Redis nodes to start...';
        sleep 10;
        echo 'Creating cluster with internal IPs...';
        redis-cli --cluster create 172.28.0.11:7000 172.28.0.12:7001 172.28.0.13:7002 172.28.0.14:7003 172.28.0.15:7004 172.28.0.16:7005 --cluster-replicas 1 --cluster-yes;
        echo 'Cluster setup complete!';
        redis-cli -h 172.28.0.11 -p 7000 cluster info;
        sleep infinity
      "
    networks:
      redis-cluster-net:
        ipv4_address: 172.28.0.20

networks:
  redis-cluster-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  cluster-data-1:
  cluster-data-2:
  cluster-data-3:
  cluster-data-4:
  cluster-data-5:
  cluster-data-6:
